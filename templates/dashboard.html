<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manager Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background:#f6f8fb; color:#2b2d33; }
        .page-title { font-weight:800; letter-spacing:.2px; }
        .kpi-card { border:0; border-left:4px solid #4c6ee6; }
        .kpi-card .kpi-value { font-size:2rem; font-weight:800; color:#111; }
        .kpi-sub { color:#667085; font-size:.85rem; }
        .kpi-occu { border-left-color:#22c55e; }
        .kpi-active { border-left-color:#f59e0b; }
        .kpi-avg { border-left-color:#06b6d4; }
        .progress { height:8px; background:#e9eef7; }
        .progress-bar { background: linear-gradient(90deg,#4c6ee6,#22c55e); }
        .card { border:0; }
        .card-header { background:#ffffff; border-bottom:1px solid #eef2f7; }
        .table thead th { color:#6b7280; font-weight:700; }
        .badge-soft { background:#eef2ff; color:#4c6ee6; }
        .section-title { font-weight:700; }
    </style>
</head>
<body>
<div class="container py-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title">ðŸ“Š Manager Dashboard</h1>
        <a href="/" class="btn btn-outline-secondary">Back to Home</a>
    </div>

    <!-- KPIs -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card kpi-card shadow-sm">
                <div class="card-body">
                    <div class="kpi-sub">Total Revenue (Completed)</div>
                    <div class="kpi-value">${{ ('%.2f'|format(revenue or 0)) }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card kpi-card kpi-avg shadow-sm">
                <div class="card-body">
                    <div class="kpi-sub">Average Room Price</div>
                    <div class="kpi-value">${{ ('%.2f'|format(avg_price or 0)) }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card kpi-card kpi-occu shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div class="kpi-sub">Occupancy</div>
                        <div class="kpi-sub">{{ occupied_rooms }}/{{ total_rooms }}</div>
                    </div>
                    <div class="kpi-value">{{ ('%.1f'|format(occupancy_rate or 0)) }}%</div>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: {{ occupancy_rate|default(0) }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card kpi-card kpi-active shadow-sm">
                <div class="card-body">
                    <div class="kpi-sub">Active Bookings</div>
                    <div class="kpi-value">{{ active_bookings }}</div>
                    <div class="kpi-sub">Available: {{ available_rooms }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-4">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 section-title">Revenue Trend (by Month)</h5>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart" height="110"></canvas>
                    <div class="text-muted small mt-2">Only Completed reservations in 2025-01..11 are counted.</div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 section-title">Booking Status Breakdown</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" height="180"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Popular types + Recent bookings -->
    <div class="row g-3">
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header">
                    <h5 class="mb-0 section-title">ðŸ”¥ Booking Analysis by Room Type</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Aggregated across all reservations.</p>
                    <table class="table table-hover align-middle">
                        <thead>
                        <tr>
                            <th>Room Type</th>
                            <th class="text-end">Bookings</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for room in popular_rooms %}
                            <tr>
                                <td><strong>{{ room.type_name }}</strong></td>
                                <td class="text-end"><span class="badge badge-soft rounded-pill">{{ room.booking_count }}</span></td>
                            </tr>
                        {% else %}
                            <tr><td colspan="2" class="text-muted">No data yet.</td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header">
                    <h5 class="mb-0 section-title">ðŸ§¾ Recent Bookings</h5>
                </div>
                <div class="card-body">
                    <table class="table table-hover align-middle">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Guest</th>
                            <th>Room</th>
                            <th>Status</th>
                            <th class="text-end">Total</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for b in recent_bookings %}
                        <tr>
                            <td>#{{ b.reservation_id }}</td>
                            <td>{{ b.guest_name }}</td>
                            <td>{{ b.room_number }} Â· {{ b.type_name }}</td>
                            <td>
                                {% set color = 'secondary' %}
                                {% if b.status == 'Booked' %}{% set color = 'warning' %}
                                {% elif b.status == 'Completed' %}{% set color = 'success' %}
                                {% elif b.status == 'Cancelled' %}{% set color = 'danger' %}
                                {% endif %}
                                <span class="badge bg-{{ color }}">{{ b.status }}</span>
                            </td>
                            <td class="text-end">${{ ('%.2f'|format(b.total_price or 0)) }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="text-muted">No bookings yet.</td></tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    <div class="text-muted small">Showing latest {{ recent_bookings|length }} records.</div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Revenue Trend (two series: revenue and bookings count)
    const revLabels = {{ rev_labels|tojson }};
    const revValues = {{ rev_values|tojson }};
    const revCounts = {{ rev_counts|tojson }};

    const ctx1 = document.getElementById('revenueChart').getContext('2d');
    new Chart(ctx1, {
        data: {
            labels: revLabels,
            datasets: [
                {
                    type: 'line',
                    label: 'Revenue ($)',
                    data: revValues,
                    yAxisID: 'y',
                    borderColor: '#4c6ee6',
                    backgroundColor: 'rgba(76,110,230,0.12)',
                    borderWidth: 2,
                    tension: .25,
                    fill: true,
                    pointRadius: 3,
                    pointBackgroundColor: '#4c6ee6'
                },
                {
                    type: 'bar',
                    label: 'Bookings (Completed)',
                    data: revCounts,
                    yAxisID: 'y2',
                    backgroundColor: '#f59e0b',
                    borderWidth: 0,
                    barPercentage: .6,
                    categoryPercentage: .7
                }
            ]
        },
        options: {
            plugins: { legend: { position: 'top' } },
            scales: {
                y: {
                    position: 'left',
                    beginAtZero: true,
                    title: { display: true, text: 'Revenue ($)' },
                    grid: { color: '#eef2f7' }
                },
                y2: {
                    position: 'right',
                    beginAtZero: true,
                    title: { display: true, text: 'Bookings' },
                    grid: { drawOnChartArea: false }
                },
                x: { grid: { display: false } }
            }
        }
    });

    // Status Breakdown
    const statusLabels = {{ status_labels|tojson }};
    const statusValues = {{ status_values|tojson }};
    const colors = ['#4c6ee6','#22c55e','#f59e0b','#ef4444','#06b6d4','#a855f7'];
    const ctx2 = document.getElementById('statusChart').getContext('2d');
    new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: statusLabels,
            datasets: [{
                data: statusValues,
                backgroundColor: colors.slice(0, statusLabels.length),
                borderWidth: 0
            }]
        },
        options: {
            plugins: { legend: { position: 'bottom' } },
            cutout: '60%'
        }
    });
</script>
</body>
</html>
